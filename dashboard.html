// Last updated: 2025-11-25 15:06:49 UTC
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldBasis - Revenue Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 40px 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        h1 { font-size: 2em; color: #94a3b8; font-weight: 400; flex-grow: 1; text-align: center; margin: 0; }
        .back-button {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .back-button:hover {
            background: #475569;
            border-color: #667eea;
            transform: translateX(-2px);
        }
        .back-button::before {
            content: '‚Üê';
            font-size: 1.2em;
        }
        .loading { text-align: center; font-size: 1.5em; color: #667eea; padding: 50px; }
        .answer {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-radius: 20px; padding: 50px; text-align: center; font-size: 2.5em;
            font-weight: 700; border: 3px solid #10b981; margin-bottom: 60px;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.2);
        }
        .answer.negative {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-color: #ef4444; box-shadow: 0 20px 60px rgba(239, 68, 68, 0.2);
        }
        .main-metric {
            background: #1e293b; border: 2px solid #334155; border-radius: 16px;
            padding: 40px; margin-bottom: 40px;
        }
        .metric-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid #334155;
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { font-size: 1.1em; color: #94a3b8; }
        .metric-value { font-size: 1.6em; font-weight: 600; color: #e2e8f0; }
        .chart-container {
            background: #1e293b; border: 2px solid #334155; border-radius: 16px;
            padding: 30px; margin-bottom: 40px;
        }
        .chart-wrapper { position: relative; height: 500px; }
        .footer { text-align: center; color: #64748b; padding: 20px; font-size: 0.9em; }
        .chart-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #0f172a;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            cursor: pointer;
            color: #94a3b8;
        }
        .success-badge {
            background: #10b981; color: white; padding: 10px 20px;
            border-radius: 8px; display: inline-block; margin-bottom: 20px;
            font-weight: 600;
        }
        .compact-range {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #334155;
        }
        .period-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .period-label {
            color: #64748b;
            font-size: 0.85em;
            margin-right: 8px;
        }
        .period-button {
            background: #0f172a;
            color: #94a3b8;
            border: 1px solid #334155;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .period-button:hover {
            border-color: #667eea;
            color: #e2e8f0;
        }
        .period-button.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            font-weight: 500;
        }
        .range-slider {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
            position: relative;
            margin: 15px 0 8px 0;
        }
        .range-slider input[type="range"] {
            position: absolute;
            width: 100%;
            height: 4px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            top: 50%;
            transform: translateY(-50%);
        }
        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            border: 2px solid #0f172a;
        }
        .range-slider input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            border: 2px solid #0f172a;
        }
        .range-fill {
            position: absolute;
            height: 4px;
            background: #667eea;
            border-radius: 2px;
            pointer-events: none;
        }
        .range-labels {
            display: flex;
            justify-content: space-between;
            color: #64748b;
            font-size: 0.75em;
        }
    
        /* Contract Version Selector */
        .contract-selector {
            display: flex;
            gap: 10px;
            background: #1e1b4b;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 15px;
            justify-content: center;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .contract-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .contract-btn:hover {
            background: #312e81;
            color: #e2e8f0;
        }

        .contract-btn.active {
            background: #8b5cf6;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="contract-selector">
            <button class="contract-btn active" data-version="new" onclick="switchContractVersion('new')">NEW Contracts</button>
            <button class="contract-btn" data-version="old" onclick="switchContractVersion('old')">OLD Contracts</button>
        </div>

        <div class="loading" id="loading">Loading synchronized data...</div>
        <div id="content" style="display:none;">
            <div class="header">
                <a href="index.html" class="back-button">Back to Vaults</a>
                <h1>YieldBasis Revenue Dashboard</h1>
                <div style="width: 140px;"></div> <!-- Spacer for centering -->
            </div>

            <div class="answer" id="answerBox">
                <span id="finalProfit">0.00000000 BTC</span>
            </div>

            <div class="chart-container">
                <h2 style="color: #94a3b8; font-size: 1.3em; margin-bottom: 20px;">Accumulated Revenue</h2>

                <div class="chart-controls" style="justify-content: space-between;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleWithdrawable" checked>
                            <label for="toggleWithdrawable">TVL</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleDeposits" checked>
                            <label for="toggleDeposits">Deposits</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleWithdrawals" checked>
                            <label for="toggleWithdrawals">Withdrawals</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleAdminFees" checked>
                            <label for="toggleAdminFees">Admin Fees</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleAdminFeeWithdrawals" checked>
                            <label for="toggleAdminFeeWithdrawals">Include Admin Fee Withdrawals</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleYbEmission" checked>
                            <label for="toggleYbEmission">YB Emission</label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleWbtc" checked>
                            <label for="toggleWbtc">WBTC</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleCbbtc" checked>
                            <label for="toggleCbbtc">cbBTC</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="toggleTbtc" checked>
                            <label for="toggleTbtc">tBTC</label>
                        </div>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <canvas id="profitChart"></canvas>
                </div>

                <div class="compact-range">
                    <div class="period-buttons">
                        <span class="period-label">Period:</span>
                        <button class="period-button" data-days="7">7d</button>
                        <button class="period-button" data-days="14">14d</button>
                        <button class="period-button" data-days="30">30d</button>
                        <button class="period-button active" data-days="all">All</button>
                    </div>
                    <div class="range-slider">
                        <div class="range-fill" id="rangeFill"></div>
                        <input type="range" id="rangeStart" min="0" max="100" value="0">
                        <input type="range" id="rangeEnd" min="0" max="100" value="100">
                    </div>
                    <div class="range-labels">
                        <span id="startLabel">Start</span>
                        <span id="endLabel">End</span>
                    </div>
                </div>
            </div>

            <div class="main-metric" id="metricsBox"></div>

            <div class="chart-container">
                <h2 style="color: #94a3b8; font-size: 1.3em; margin-bottom: 20px;">TVL by Markets</h2>
                <div class="chart-wrapper">
                    <canvas id="tvlByMarketChart"></canvas>
                </div>
            </div>

            <div class="footer" id="footer"></div>
        </div>
    </div>

    <!-- Load SYNCHRONIZED data files -->
    <script src="revenue_yield_wbtc_sync.js?v=6"></script>
    <script src="revenue_yield_cbbtc_sync.js?v=6"></script>
    <script src="revenue_yield_tbtc_sync.js?v=6"></script>
    <script src="yb_emission_data.js?v=6"></script>

    <!-- Load OLD contract data files -->
    <script src="old_revenue_yield_wbtc_sync.js?v=6"></script>
    <script src="old_revenue_yield_cbbtc_sync.js?v=6"></script>
    <script src="old_revenue_yield_tbtc_sync.js?v=6"></script>
    <script src="old_yb_emission_data.js?v=6"></script>

    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º 'new' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let currentContractVersion = localStorage.getItem('contractVersion') || 'new';

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É NEW –∏ OLD –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏
    function switchContractVersion(version) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ localStorage
        localStorage.setItem('contractVersion', version);
        currentContractVersion = version;

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        location.reload();
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.contract-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-version') === currentContractVersion) {
                btn.classList.add('active');
            }
        });
    });

    window.addEventListener('load', async function() {
        try {
            console.log('Loading synchronized data...');
            console.log('Contract version:', currentContractVersion);

            // –í—ã–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
            let yieldDataSource_wbtc, yieldDataSource_cbbtc, yieldDataSource_tbtc, ybEmissionDataSource;

            if (currentContractVersion === 'old') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ OLD –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (typeof old_yieldData_wbtc === 'undefined' ||
                    typeof old_yieldData_cbbtc === 'undefined' ||
                    typeof old_yieldData_tbtc === 'undefined') {
                    throw new Error('OLD contract data files not found.');
                }
                yieldDataSource_wbtc = old_yieldData_wbtc;
                yieldDataSource_cbbtc = old_yieldData_cbbtc;
                yieldDataSource_tbtc = old_yieldData_tbtc;
                ybEmissionDataSource = typeof old_ybEmissionData !== 'undefined' ? old_ybEmissionData : null;
            } else {
                // NEW –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                if (typeof yieldData_wbtc === 'undefined' ||
                    typeof yieldData_cbbtc === 'undefined' ||
                    typeof yieldData_tbtc === 'undefined') {
                    throw new Error('Synchronized data files not found. Run: python collect_sync.py');
                }
                yieldDataSource_wbtc = yieldData_wbtc;
                yieldDataSource_cbbtc = yieldData_cbbtc;
                yieldDataSource_tbtc = yieldData_tbtc;
                ybEmissionDataSource = typeof ybEmissionData !== 'undefined' ? ybEmissionData : null;
            }

            // –î–∞–Ω–Ω—ã–µ –£–ñ–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã - –ø—Ä–æ—Å—Ç–æ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º!
            const wbtcData = yieldDataSource_wbtc.data;
            const cbbtcData = yieldDataSource_cbbtc.data;
            const tbtcData = yieldDataSource_tbtc.data;

            console.log('WBTC points:', wbtcData.length);
            console.log('cbBTC points:', cbbtcData.length);
            console.log('tBTC points:', tbtcData.length);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            if (wbtcData.length !== cbbtcData.length || wbtcData.length !== tbtcData.length) {
                throw new Error('Data is not synchronized! Re-run collect_sync.py');
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ profit data
            function recalculateProfitData() {
                let cumulativeDeposits = 0;
                let cumulativeWithdrawals = 0;
                let cumulativeAdminFeeWithdrawals = 0;

                return wbtcData.map((wbtc, i) => {
                const cbbtc = cbbtcData[i];
                const tbtc = tbtcData[i];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ timestamps —Å–æ–≤–ø–∞–¥–∞—é—Ç
                if (wbtc.timestamp !== cbbtc.timestamp || wbtc.timestamp !== tbtc.timestamp) {
                    console.warn(`Timestamp mismatch at index ${i}`);
                }

                // –°–∫–ª–∞–¥—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Ä—ã–Ω–∫–æ–≤
                const totalWithdrawable = (wbtc.total_withdrawable_btc || 0) +
                                         (cbbtc.total_withdrawable_btc || 0) +
                                         (tbtc.total_withdrawable_btc || 0);

                const deposits = (wbtc.deposits_btc || 0) +
                                (cbbtc.deposits_btc || 0) +
                                (tbtc.deposits_btc || 0);

                const withdrawals = (wbtc.withdrawals_btc || 0) +
                                   (cbbtc.withdrawals_btc || 0) +
                                   (tbtc.withdrawals_btc || 0);

                // –ò–°–ü–†–ê–í–õ–ï–ù–û: admin_fee_withdrawals_btc - —ç—Ç–æ –¥–µ–ª—å—Ç–∞ –≤—ã–≤–æ–¥–æ–≤ admin fees
                // –î–ª—è OLD –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —ç—Ç–æ –ø–æ–ª–µ = 0 (–Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤)
                // –î–ª—è NEW –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —ç—Ç–æ –ø–æ–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–ª—å—Ç—ã
                // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º admin_fees_btc –∑–¥–µ—Å—å, —Ç.–∫. —ç—Ç–æ –∫—É–º—É–ª—è—Ç–∏–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
                const adminFeeWithdrawals = (wbtc.admin_fee_withdrawals_btc || 0) +
                                           (cbbtc.admin_fee_withdrawals_btc || 0) +
                                           (tbtc.admin_fee_withdrawals_btc || 0);

                const adminFees = (wbtc.admin_fees_btc || 0) +
                                 (cbbtc.admin_fees_btc || 0) +
                                 (tbtc.admin_fees_btc || 0);

                // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º
                cumulativeDeposits += deposits;
                cumulativeWithdrawals += withdrawals;
                cumulativeAdminFeeWithdrawals += adminFeeWithdrawals;

                // –î–æ–±–∞–≤–ª—è–µ–º admin fee withdrawals –∫ withdrawals –µ—Å–ª–∏ checkbox –∞–∫—Ç–∏–≤–µ–Ω
                const includeAdminFeeWithdrawals = document.getElementById('toggleAdminFeeWithdrawals')?.checked ?? true;
                const effectiveWithdrawals = includeAdminFeeWithdrawals
                    ? cumulativeWithdrawals + cumulativeAdminFeeWithdrawals
                    : cumulativeWithdrawals;

                // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å
                // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω checkbox, –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–∏–µ adminFees –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–µ–¥–µ–Ω–Ω–æ–π —Å—É–º–º—ã
                const effectiveAdminFees = includeAdminFeeWithdrawals
                    ? adminFees + cumulativeAdminFeeWithdrawals
                    : adminFees;
                const netDeposited = cumulativeDeposits - effectiveWithdrawals;
                const profit = totalWithdrawable - netDeposited + effectiveAdminFees;

                return {
                    timestamp: wbtc.timestamp,
                    date: new Date(wbtc.timestamp * 1000).toLocaleDateString('en-US'),
                    profit: profit,
                    withdrawable: totalWithdrawable,
                    deposits: cumulativeDeposits,
                    withdrawals: effectiveWithdrawals,
                    admin_fees: adminFees,
                    admin_fee_withdrawals: cumulativeAdminFeeWithdrawals
                };
                });
            }

            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
            let profitData = recalculateProfitData();

            console.log('Profit data points:', profitData.length);

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
            const lastPoint = profitData[profitData.length - 1];
            const finalProfit = lastPoint.profit;
            const finalTVL = lastPoint.withdrawable;  // TVL –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤

            document.getElementById('finalProfit').textContent = finalProfit.toFixed(8) + ' BTC';
            document.getElementById('answerBox').className = 'answer';  // –í—Å–µ–≥–¥–∞ –∑–µ–ª–µ–Ω—ã–π

            // –í—ã—á–∏—Å–ª—è–µ–º YB emission –¥–ª—è –º–µ—Ç—Ä–∏–∫ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
            let totalYbEmissionBtc = 0;

            const metricsHTML = `
                <div class="metric-row">
                    <div class="metric-label">TVL (Withdrawable)</div>
                    <div class="metric-value">${lastPoint.withdrawable.toFixed(2)} BTC</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Total Deposits</div>
                    <div class="metric-value">${lastPoint.deposits.toFixed(2)} BTC</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Total Withdrawals</div>
                    <div class="metric-value">${lastPoint.withdrawals.toFixed(2)} BTC</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Net Deposited</div>
                    <div class="metric-value">${(lastPoint.deposits - lastPoint.withdrawals).toFixed(2)} BTC</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Admin Fees</div>
                    <div class="metric-value">${lastPoint.admin_fees.toFixed(4)} BTC</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Admin Fee Withdrawals</div>
                    <div class="metric-value">${lastPoint.admin_fee_withdrawals.toFixed(4)} BTC</div>
                </div>
                <div class="metric-row" id="ybEmissionMetric" style="display:none;">
                    <div class="metric-label">YB Emission</div>
                    <div class="metric-value" id="ybEmissionValue">0.0000 BTC</div>
                </div>
            `;
            document.getElementById('metricsBox').innerHTML = metricsHTML;

            // Footer
            const startDate = new Date(profitData[0].timestamp * 1000).toLocaleDateString('en-US');
            const endDate = new Date(profitData[profitData.length - 1].timestamp * 1000).toLocaleDateString('en-US');
            document.getElementById('footer').textContent =
                `Synchronized data | Points: ${profitData.length} | Period: ${startDate} - ${endDate}`;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö YB emission (–∏–∑ JS —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è CORS –ø—Ä–æ–±–ª–µ–º—ã)
            let ybEmissionDataArray = null;
            try {
                if (ybEmissionDataSource) {
                    ybEmissionDataArray = ybEmissionDataSource;
                    console.log('YB emission data loaded:', ybEmissionDataArray.length, 'points');
                } else {
                    console.log('YB emission data not available');
                }
            } catch (error) {
                console.log('YB emission data not available:', error.message);
            }

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö YB emission –¥–ª—è —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π (–ø–æ —Ä—ã–Ω–∫–∞–º)
            if (ybEmissionDataArray) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –±–µ–∑ BTC –ø–æ–ª–µ–π (–Ω–µ–ø–æ–ª–Ω—ã–µ –∑–∞–ø–∏—Å–∏)
                const validYbData = ybEmissionDataArray.filter(item => 
                    item.cumulative_WBTC_btc !== undefined &&
                    item.cumulative_cbBTC_btc !== undefined &&
                    item.cumulative_tBTC_btc !== undefined
                );

                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä—ã–Ω–∫–∞ (hourly –¥–∞–Ω–Ω—ã–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º timestamp –Ω–∞–ø—Ä—è–º—É—é)
                const ybDatesWbtc = validYbData.map(item => ({
                    timestamp: item.timestamp,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º timestamp –Ω–∞–ø—Ä—è–º—É—é (hourly –¥–∞–Ω–Ω—ã–µ)
                    value: item.cumulative_WBTC_btc || 0
                })).sort((a, b) => a.timestamp - b.timestamp);

                const ybDatesCbbtc = validYbData.map(item => ({
                    timestamp: item.timestamp,
                    value: item.cumulative_cbBTC_btc || 0
                })).sort((a, b) => a.timestamp - b.timestamp);

                const ybDatesTbtc = validYbData.map(item => ({
                    timestamp: item.timestamp,
                    value: item.cumulative_tBTC_btc || 0
                })).sort((a, b) => a.timestamp - b.timestamp);

                console.log('YB emission –ø–æ —Ä—ã–Ω–∫–∞–º –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å—Å—è');

                // –§—É–Ω–∫—Ü–∏—è –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞
                function interpolateYbEmission(timestamp, ybDates) {
                    if (ybDates.length === 0) return 0;

                    // –ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –ø–µ—Ä–≤–æ–π –¥–∞—Ç—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
                    if (timestamp < ybDates[0].timestamp) return 0;

                    // –ï—Å–ª–∏ –ø–æ–∑–∂–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    if (timestamp >= ybDates[ybDates.length - 1].timestamp) {
                        return ybDates[ybDates.length - 1].value;
                    }

                    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–µ —Ç–æ—á–∫–∏
                    for (let i = 0; i < ybDates.length - 1; i++) {
                        if (timestamp >= ybDates[i].timestamp && timestamp < ybDates[i + 1].timestamp) {
                            const lower = ybDates[i];
                            const upper = ybDates[i + 1];

                            // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                            const ratio = (timestamp - lower.timestamp) / (upper.timestamp - lower.timestamp);
                            return lower.value + ratio * (upper.value - lower.value);
                        }
                    }

                    return 0;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º YB emission –∫ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ profitData —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π (–ø–æ —Ä—ã–Ω–∫–∞–º)
                profitData.forEach(point => {
                    point.yb_emission_wbtc_btc = interpolateYbEmission(point.timestamp, ybDatesWbtc);
                    point.yb_emission_cbbtc_btc = interpolateYbEmission(point.timestamp, ybDatesCbbtc);
                    point.yb_emission_tbtc_btc = interpolateYbEmission(point.timestamp, ybDatesTbtc);
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É YB emission
                const lastPointIndex = profitData.length - 1;
                const totalYbEmission = (profitData[lastPointIndex].yb_emission_wbtc_btc || 0) +
                                       (profitData[lastPointIndex].yb_emission_cbbtc_btc || 0) +
                                       (profitData[lastPointIndex].yb_emission_tbtc_btc || 0);

                document.getElementById('ybEmissionMetric').style.display = 'flex';
                document.getElementById('ybEmissionValue').textContent = totalYbEmission.toFixed(4) + ' BTC';
            } else {
                profitData.forEach(point => {
                    point.yb_emission_wbtc_btc = 0;
                    point.yb_emission_cbbtc_btc = 0;
                    point.yb_emission_tbtc_btc = 0;
                });
            }

            // Profit Chart
            let profitChart;  // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∑–∞—Ä–∞–Ω–µ–µ
            const datasets = [{
                label: 'in BTC',
                data: profitData.map(d => ({x: d.timestamp * 1000, y: d.profit})),
                borderColor: '#10b981',  // –í—Å–µ–≥–¥–∞ –∑–µ–ª–µ–Ω—ã–π
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 5,
                stepped: false,
                spanGaps: true
            }];

            profitChart = new Chart(document.getElementById('profitChart'), {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#94a3b8', font: { size: 14 } } },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: ctx => {
                                    const index = ctx[0].dataIndex;
                                    const point = profitData[index];
                                    const wbtc = wbtcData[index];

                                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                                    const date = new Date(point.timestamp * 1000);
                                    const dateStr = date.toLocaleDateString('en-US');
                                    const timeStr = date.toLocaleTimeString('en-US');

                                    return [
                                        `üìÖ ${dateStr} ${timeStr}`,
                                        `üîó Block: ${wbtc.block}`
                                    ];
                                },
                                label: ctx => {
                                    return '';  // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                                },
                                afterLabel: ctx => {
                                    const point = profitData[ctx.dataIndex];
                                    const netDeposited = point.deposits - point.withdrawals;
                                    const percentOfTVL = (point.profit / finalTVL * 100).toFixed(2);

                                    const lines = [
                                        '',
                                        'üìä ACCUMULATED REVENUE CALCULATION:',
                                        '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                                        `TVL (available):       +${point.withdrawable.toFixed(4)} BTC`,
                                        `Net Deposited:        -${netDeposited.toFixed(4)} BTC`,
                                        `  (Deposits: ${point.deposits.toFixed(2)} BTC)`,
                                        `  (Withdrawals: ${point.withdrawals.toFixed(2)} BTC)`,
                                        `Admin Fees:           +${point.admin_fees.toFixed(4)} BTC`
                                    ];

                                    // –î–æ–±–∞–≤–ª—è–µ–º YB emission –ø–æ —Ä—ã–Ω–∫–∞–º –µ—Å–ª–∏ –µ—Å—Ç—å
                                    const totalYbEmission = (point.yb_emission_wbtc_btc || 0) +
                                                           (point.yb_emission_cbbtc_btc || 0) +
                                                           (point.yb_emission_tbtc_btc || 0);

                                    if (totalYbEmission > 0) {
                                        lines.push('');
                                        lines.push('YB Emission by Market:');
                                        if (point.yb_emission_wbtc_btc) {
                                            lines.push(`  WBTC:  +${point.yb_emission_wbtc_btc.toFixed(4)} BTC`);
                                        }
                                        if (point.yb_emission_cbbtc_btc) {
                                            lines.push(`  cbBTC: +${point.yb_emission_cbbtc_btc.toFixed(4)} BTC`);
                                        }
                                        if (point.yb_emission_tbtc_btc) {
                                            lines.push(`  tBTC:  +${point.yb_emission_tbtc_btc.toFixed(4)} BTC`);
                                        }
                                        lines.push(`  TOTAL: +${totalYbEmission.toFixed(4)} BTC`);
                                    }

                                    const totalProfit = point.profit + totalYbEmission;

                                    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                                    lines.push(`üí∞ BALANCE (w/o YB):  ${point.profit.toFixed(4)} BTC (${percentOfTVL}% of TVL)`);

                                    if (totalYbEmission > 0) {
                                        lines.push(`üí∞ BALANCE (w/ YB):   ${totalProfit.toFixed(4)} BTC`);
                                    }

                                    lines.push('');
                                    lines.push('Formula: TVL - (Deposits - Withdrawals) + Admin Fees + YB');

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            ticks: { color: '#64748b' },
                            grid: { color: '#1e293b' }
                        },
                        y: {
                            position: 'left',
                            ticks: { color: '#64748b' },
                            grid: { color: '#1e293b' },
                            title: {
                                display: true,
                                text: 'BTC',
                                color: '#94a3b8'
                            }
                        },
                        y1: {
                            position: 'right',
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10,
                                callback: function(value) {
                                    return value.toFixed(3) + '%';
                                }
                            },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: '% of TVL',
                                color: '#94a3b8'
                            },
                            // –°–≤—è–∑—ã–≤–∞–µ–º —Å –ª–µ–≤–æ–π –æ—Å—å—é —á–µ—Ä–µ–∑ afterDataLimits
                            afterDataLimits: function(axis) {
                                const leftAxis = axis.chart.scales.y;
                                const percentPerBTC = 100 / finalTVL;

                                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º min/max —Å –ª–µ–≤–æ–π –æ—Å—å—é
                                axis.min = leftAxis.min * percentPerBTC;
                                axis.max = leftAxis.max * percentPerBTC;
                            }
                        }
                    }
                }
            });

            // TVL by Market Chart
            const tvlByMarketChart = new Chart(document.getElementById('tvlByMarketChart'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'WBTC TVL',
                            data: wbtcData.map((d, i) => ({x: profitData[i].timestamp * 1000, y: d.total_withdrawable_btc})),
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'cbBTC TVL',
                            data: cbbtcData.map((d, i) => ({x: profitData[i].timestamp * 1000, y: d.total_withdrawable_btc})),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'tBTC TVL',
                            data: tbtcData.map((d, i) => ({x: profitData[i].timestamp * 1000, y: d.total_withdrawable_btc})),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#94a3b8', font: { size: 14 } } },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: ctx => {
                                    const index = ctx[0].dataIndex;
                                    const point = profitData[index];
                                    const wbtc = wbtcData[index];

                                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                                    const date = new Date(point.timestamp * 1000);
                                    const dateStr = date.toLocaleDateString('en-US');
                                    const timeStr = date.toLocaleTimeString('en-US');

                                    return [
                                        `üìÖ ${dateStr} ${timeStr}`,
                                        `üîó Block: ${wbtc.block}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            ticks: { color: '#64748b' },
                            grid: { color: '#1e293b' }
                        },
                        y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
                    }
                }
            });

            // ====== RANGE SLIDER LOGIC ======

            // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const fullProfitData = [...profitData];
            const fullWbtcData = [...wbtcData];
            const fullCbbtcData = [...cbbtcData];
            const fullTbtcData = [...tbtcData];

            let currentRangeStart = 0;
            let currentRangeEnd = fullProfitData.length - 1;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞
            function updateSliderUI() {
                const rangeStart = document.getElementById('rangeStart');
                const rangeEnd = document.getElementById('rangeEnd');
                const rangeFill = document.getElementById('rangeFill');
                const startLabel = document.getElementById('startLabel');
                const endLabel = document.getElementById('endLabel');

                const startPercent = (parseInt(rangeStart.value) / parseInt(rangeStart.max)) * 100;
                const endPercent = (parseInt(rangeEnd.value) / parseInt(rangeEnd.max)) * 100;

                rangeFill.style.left = startPercent + '%';
                rangeFill.style.width = (endPercent - startPercent) + '%';

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏
                const startDate = new Date(fullProfitData[currentRangeStart].timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endDate = new Date(fullProfitData[currentRangeEnd].timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                startLabel.textContent = startDate;
                endLabel.textContent = endDate;
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É (–±–µ–∑ –ø–µ—Ä–µ—Å—á–µ—Ç–∞)
            function filterDataByRange() {
                profitData.length = 0;
                wbtcData.length = 0;
                cbbtcData.length = 0;
                tbtcData.length = 0;

                for (let i = currentRangeStart; i <= currentRangeEnd; i++) {
                    profitData.push(fullProfitData[i]);
                    wbtcData.push(fullWbtcData[i]);
                    cbbtcData.push(fullCbbtcData[i]);
                    tbtcData.push(fullTbtcData[i]);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ë–ï–ó –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (–ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω)
                updateChartsRange();
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤
            document.getElementById('rangeStart').addEventListener('input', function() {
                let startValue = parseInt(this.value);
                let endValue = parseInt(document.getElementById('rangeEnd').value);

                if (startValue >= endValue) {
                    startValue = endValue - 1;
                    this.value = startValue;
                }

                currentRangeStart = Math.floor((startValue / 100) * (fullProfitData.length - 1));
                updateSliderUI();
            });

            document.getElementById('rangeEnd').addEventListener('input', function() {
                let startValue = parseInt(document.getElementById('rangeStart').value);
                let endValue = parseInt(this.value);

                if (endValue <= startValue) {
                    endValue = startValue + 1;
                    this.value = endValue;
                }

                currentRangeEnd = Math.floor((endValue / 100) * (fullProfitData.length - 1));
                updateSliderUI();
            });

            document.getElementById('rangeStart').addEventListener('change', filterDataByRange);
            document.getElementById('rangeEnd').addEventListener('change', filterDataByRange);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–æ–≤
            document.querySelectorAll('.period-button').forEach(button => {
                button.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    document.querySelectorAll('.period-button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const days = this.getAttribute('data-days');

                    if (days === 'all') {
                        currentRangeStart = 0;
                        currentRangeEnd = fullProfitData.length - 1;
                    } else {
                        const daysNum = parseInt(days);
                        currentRangeEnd = fullProfitData.length - 1;

                        // –ò—â–µ–º —Ç–æ—á–∫—É N –¥–Ω–µ–π –Ω–∞–∑–∞–¥
                        const endTimestamp = fullProfitData[currentRangeEnd].timestamp;
                        const targetTimestamp = endTimestamp - (daysNum * 86400);

                        currentRangeStart = fullProfitData.findIndex(p => p.timestamp >= targetTimestamp);
                        if (currentRangeStart === -1) currentRangeStart = 0;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–∫–∏
                    const startPercent = (currentRangeStart / (fullProfitData.length - 1)) * 100;
                    const endPercent = (currentRangeEnd / (fullProfitData.length - 1)) * 100;

                    document.getElementById('rangeStart').value = startPercent;
                    document.getElementById('rangeEnd').value = endPercent;

                    updateSliderUI();
                    filterDataByRange();
                });
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–∞
            updateSliderUI();

            // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –í–°–ï–ì–û –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            let fullRecalculatedData = null;

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ë–ï–ó –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
            function updateChartsRange() {
                // –ë–µ—Ä–µ–º –Ω—É–∂–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∏–∑ —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (fullRecalculatedData) {
                    const rangeData = fullRecalculatedData.slice(currentRangeStart, currentRangeEnd + 1);
                    profitChart.data.datasets[0].data = profitData.map((d, i) => ({
                        x: d.timestamp * 1000,
                        y: rangeData[i]
                    }));
                } else {
                    // –ï—Å–ª–∏ –µ—â–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    profitChart.data.datasets[0].data = profitData.map(d => ({
                        x: d.timestamp * 1000,
                        y: d.profit
                    }));
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const lastData = profitChart.data.datasets[0].data[profitChart.data.datasets[0].data.length - 1];
                document.getElementById('finalProfit').textContent = lastData.y.toFixed(8) + ' BTC';

                profitChart.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º TVL –≥—Ä–∞—Ñ–∏–∫
                tvlByMarketChart.data.datasets[0].data = wbtcData.map((d, i) => ({
                    x: profitData[i].timestamp * 1000,
                    y: d.total_withdrawable_btc
                }));
                tvlByMarketChart.data.datasets[1].data = cbbtcData.map((d, i) => ({
                    x: profitData[i].timestamp * 1000,
                    y: d.total_withdrawable_btc
                }));
                tvlByMarketChart.data.datasets[2].data = tbtcData.map((d, i) => ({
                    x: profitData[i].timestamp * 1000,
                    y: d.total_withdrawable_btc
                }));
                tvlByMarketChart.update();
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –° –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤)
            function updateAllCharts() {
                // –í—ã–∑—ã–≤–∞–µ–º updateChart –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
                updateChart();
            }

            // ====== END RANGE SLIDER LOGIC ======

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–µ–∫–±–æ–∫—Å–æ–≤
            function updateChart() {
                const includeWithdrawable = document.getElementById('toggleWithdrawable').checked;
                const includeDeposits = document.getElementById('toggleDeposits').checked;
                const includeWithdrawals = document.getElementById('toggleWithdrawals').checked;
                const includeAdminFees = document.getElementById('toggleAdminFees').checked;
                const includeYbEmission = document.getElementById('toggleYbEmission').checked;

                // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä—ã–Ω–∫–∏
                const includeWbtc = document.getElementById('toggleWbtc').checked;
                const includeCbbtc = document.getElementById('toggleCbbtc').checked;
                const includeTbtc = document.getElementById('toggleTbtc').checked;

                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏—Ç –¥–ª—è –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
                let cumulativeDeposits = 0;
                let cumulativeWithdrawals = 0;
                let cumulativeAdminFeeWithdrawals = 0;

                fullRecalculatedData = fullProfitData.map((point, i) => {
                    const wbtc = fullWbtcData[i];
                    const cbbtc = fullCbbtcData[i];
                    const tbtc = fullTbtcData[i];

                    // –°—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä—ã–Ω–∫–∏
                    let withdrawable = 0;
                    let deposits = 0;
                    let withdrawals = 0;
                    let adminFees = 0;
                    let adminFeeWithdrawals = 0;

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º admin_fee_withdrawals_btc (–¥–µ–ª—å—Ç–∞)
                    // –î–ª—è OLD –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ —ç—Ç–æ = 0, –¥–ª—è NEW - —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–ª—å—Ç—ã
                    if (includeWbtc) {
                        withdrawable += wbtc.total_withdrawable_btc || 0;
                        deposits += wbtc.deposits_btc || 0;
                        withdrawals += wbtc.withdrawals_btc || 0;
                        adminFees += wbtc.admin_fees_btc || 0;
                        adminFeeWithdrawals += wbtc.admin_fee_withdrawals_btc || 0;
                    }
                    if (includeCbbtc) {
                        withdrawable += cbbtc.total_withdrawable_btc || 0;
                        deposits += cbbtc.deposits_btc || 0;
                        withdrawals += cbbtc.withdrawals_btc || 0;
                        adminFees += cbbtc.admin_fees_btc || 0;
                        adminFeeWithdrawals += cbbtc.admin_fee_withdrawals_btc || 0;
                    }
                    if (includeTbtc) {
                        withdrawable += tbtc.total_withdrawable_btc || 0;
                        deposits += tbtc.deposits_btc || 0;
                        withdrawals += tbtc.withdrawals_btc || 0;
                        adminFees += tbtc.admin_fees_btc || 0;
                        adminFeeWithdrawals += tbtc.admin_fee_withdrawals_btc || 0;
                    }

                    // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –¥–µ–ø–æ–∑–∏—Ç—ã/–≤—ã–≤–æ–¥—ã
                    cumulativeDeposits += deposits;
                    cumulativeWithdrawals += withdrawals;
                    cumulativeAdminFeeWithdrawals += adminFeeWithdrawals;

                    // –í—ã—á–∏—Å–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                    let profit = 0;

                    if (includeWithdrawable) {
                        profit += withdrawable;
                    }
                    if (includeDeposits) {
                        profit -= cumulativeDeposits;
                    }
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ admin fee withdrawals (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö –≥–∞–ª–æ—á–µ–∫)
                    const includeAdminFeeWithdrawals = document.getElementById('toggleAdminFeeWithdrawals')?.checked ?? true;
                    let adminFeeWithdrawalsAdded = false;

                    if (includeWithdrawals) {
                        const effectiveWithdrawals = includeAdminFeeWithdrawals
                            ? cumulativeWithdrawals + cumulativeAdminFeeWithdrawals
                            : cumulativeWithdrawals;
                        profit += effectiveWithdrawals;
                        if (includeAdminFeeWithdrawals) {
                            adminFeeWithdrawalsAdded = true;
                        }
                    }

                    if (includeAdminFees) {
                        const effectiveAdminFees = includeAdminFeeWithdrawals
                            ? adminFees + cumulativeAdminFeeWithdrawals
                            : adminFees;
                        profit += effectiveAdminFees;
                        if (includeAdminFeeWithdrawals) {
                            adminFeeWithdrawalsAdded = true;
                        }
                    }

                    // –ï—Å–ª–∏ admin fee withdrawals –≤–∫–ª—é—á–µ–Ω—ã, –Ω–æ –æ–Ω–∏ –µ—â–µ –Ω–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∏ —á–µ—Ä–µ–∑ withdrawals, –Ω–∏ —á–µ—Ä–µ–∑ admin fees
                    if (includeAdminFeeWithdrawals && !adminFeeWithdrawalsAdded) {
                        profit += cumulativeAdminFeeWithdrawals;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º YB —ç–º–∏—Å—Å–∏—é –ø–æ —Ä—ã–Ω–∫–∞–º –µ—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    if (includeYbEmission) {
                        if (includeWbtc && point.yb_emission_wbtc_btc) {
                            profit += point.yb_emission_wbtc_btc;
                        }
                        if (includeCbbtc && point.yb_emission_cbbtc_btc) {
                            profit += point.yb_emission_cbbtc_btc;
                        }
                        if (includeTbtc && point.yb_emission_tbtc_btc) {
                            profit += point.yb_emission_tbtc_btc;
                        }
                    }

                    return profit;
                });

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
                const rangeData = fullRecalculatedData.slice(currentRangeStart, currentRangeEnd + 1);

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å timestamps
                profitChart.data.datasets[0].data = profitData.map((d, i) => ({
                    x: d.timestamp * 1000,
                    y: rangeData[i]
                }));

                // –¶–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –∑–µ–ª–µ–Ω—ã–π - —ç—Ç–æ –±–∞–ª–∞–Ω—Å –ø—Ä–æ—Ç–æ–∫–æ–ª–∞, –Ω–µ –ø—Ä–æ—Ñ–∏—Ç/—É–±—ã—Ç–æ–∫
                profitChart.data.datasets[0].borderColor = '#10b981';
                profitChart.data.datasets[0].backgroundColor = 'rgba(16, 185, 129, 0.1)';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                const finalValue = rangeData[rangeData.length - 1];
                document.getElementById('finalProfit').textContent = finalValue.toFixed(8) + ' BTC';
                document.getElementById('answerBox').className = 'answer';  // –í—Å–µ–≥–¥–∞ –∑–µ–ª–µ–Ω—ã–π

                profitChart.update();
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Admin Fee Withdrawals checkbox
            function updateMetricsAndChart() {
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º profitData
                profitData = recalculateProfitData();

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                const lastPoint = profitData[profitData.length - 1];
                document.getElementById('finalProfit').textContent = lastPoint.profit.toFixed(8) + ' BTC';

                // –û–±–Ω–æ–≤–ª—è–µ–º metrics box
                document.querySelector('#metricsBox .metric-row:nth-child(2) .metric-value').textContent =
                    lastPoint.deposits.toFixed(2) + ' BTC';
                document.querySelector('#metricsBox .metric-row:nth-child(3) .metric-value').textContent =
                    lastPoint.withdrawals.toFixed(2) + ' BTC';
                document.querySelector('#metricsBox .metric-row:nth-child(4) .metric-value').textContent =
                    (lastPoint.deposits - lastPoint.withdrawals).toFixed(2) + ' BTC';
                document.querySelector('#metricsBox .metric-row:nth-child(6) .metric-value').textContent =
                    lastPoint.admin_fee_withdrawals.toFixed(4) + ' BTC';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º YB Emission –º–µ—Ç—Ä–∏–∫—É
                if (lastPoint.yb_emission_wbtc_btc !== undefined) {
                    const totalYbEmission = (lastPoint.yb_emission_wbtc_btc || 0) +
                                           (lastPoint.yb_emission_cbbtc_btc || 0) +
                                           (lastPoint.yb_emission_tbtc_btc || 0);
                    document.getElementById('ybEmissionValue').textContent = totalYbEmission.toFixed(4) + ' BTC';
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                updateChart();
            }

            // –ü–æ–¥–∫–ª—é—á–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('toggleWithdrawable').addEventListener('change', updateChart);
            document.getElementById('toggleDeposits').addEventListener('change', updateChart);
            document.getElementById('toggleWithdrawals').addEventListener('change', updateChart);
            document.getElementById('toggleAdminFees').addEventListener('change', updateChart);
            document.getElementById('toggleAdminFeeWithdrawals').addEventListener('change', updateMetricsAndChart);

            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≥–∞–ª–æ—á–∫–∏ —Ä—ã–Ω–∫–æ–≤
            document.getElementById('toggleWbtc').addEventListener('change', updateChart);
            document.getElementById('toggleCbbtc').addEventListener('change', updateChart);
            document.getElementById('toggleTbtc').addEventListener('change', updateChart);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è YB emission
            if (ybEmissionDataArray && ybEmissionDataArray.length > 0) {
                document.getElementById('toggleYbEmission').addEventListener('change', updateChart);
                // –í—ã–∑—ã–≤–∞–µ–º updateChart —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å YB emission —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
                updateChart();
            } else {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –æ—Ç–∫–ª—é—á–∞–µ–º –≥–∞–ª–æ—á–∫—É
                document.getElementById('toggleYbEmission').disabled = true;
                document.getElementById('toggleYbEmission').checked = false;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

        } catch (error) {
            document.getElementById('loading').innerHTML = `
                <div style="color: #ef4444;">
                    <h2>Error: ${error.message}</h2>
                    <p style="margin-top: 20px; color: #94a3b8;">
                        Run: <code style="background: #1e293b; padding: 5px 10px; border-radius: 4px;">python collect_sync.py</code>
                    </p>
                </div>
            `;
            console.error('Error:', error);
        }
    });
    </script>
</body>
</html>







