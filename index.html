<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Basis BTC Vaults - Yield Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            flex: 1;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1em;
        }

        .market-selector {
            display: flex;
            gap: 10px;
            background: #0f172a;
            padding: 6px;
            border-radius: 8px;
        }

        .market-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .market-btn:hover {
            background: #1e293b;
            color: #e2e8f0;
        }

        .market-btn.active {
            background: #f59e0b;
            color: #0f172a;
        }

        .date-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
        }

        .date-input-group label {
            color: #94a3b8;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .date-input-group input {
            padding: 8px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #f59e0b;
            border: none;
            border-radius: 6px;
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #334155;
            border: none;
            border-radius: 6px;
            color: #e2e8f0;
            font-weight: 600;
            cursor: pointer;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #e2e8f0;
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .chart-container {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }

        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #f59e0b;
        }

        canvas {
            max-height: 400px;
        }

        .info {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            border-left: 4px solid #f59e0b;
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #f59e0b;
        }

        .info-content {
            color: #94a3b8;
            line-height: 1.6;
        }

        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .error {
            background: #7f1d1d;
            color: #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-title">
                    <h1 id="page-title">Yield Basis BTC Vaults - Yield Analytics</h1>
                    <p class="subtitle">BTC-Denominated Performance Analysis</p>
                </div>
                <div class="market-selector">
                    <button class="market-btn active" data-market="wbtc" onclick="switchMarket('wbtc')">yb-WBTC</button>
                    <button class="market-btn" data-market="cbbtc" onclick="switchMarket('cbbtc')">yb-cbBTC</button>
                    <button class="market-btn" data-market="tbtc" onclick="switchMarket('tbtc')">yb-tBTC</button>
                    <button class="market-btn" data-market="syb_wbtc" onclick="switchMarket('syb_wbtc')">syb-WBTC</button>
                    <button class="market-btn" data-market="syb_cbbtc" onclick="switchMarket('syb_cbbtc')">syb-cbBTC</button>
                    <button class="market-btn" data-market="syb_tbtc" onclick="switchMarket('syb_tbtc')">syb-tBTC</button>
                </div>
            </div>
            <div class="date-filters">
                <div class="date-input-group">
                    <label for="startDate">Start Date</label>
                    <input type="datetime-local" id="startDate">
                </div>
                <div class="date-input-group">
                    <label for="endDate">End Date</label>
                    <input type="datetime-local" id="endDate">
                </div>
                <div>
                    <button class="btn-primary" onclick="applyDateFilter()">Apply</button>
                    <button class="btn-secondary" onclick="resetDateFilter()" style="margin-left: 10px;">Reset</button>
                </div>
            </div>
        </header>

        <div id="content-area">
            <div class="loading">Loading market data...</div>
        </div>
    </div>

    <!-- Load all market data files with cache busting -->
    <script src="../yield_data.js?v=4"></script>
    <script>
        // Store wbtc data immediately after loading
        const wbtcData = JSON.parse(JSON.stringify(yieldData));
        console.log('Loaded WBTC data:', wbtcData.metadata.contract, wbtcData.data.length, 'points');
    </script>
    <script src="../yield_cbbtc.js?v=4"></script>
    <script>
        // Store cbbtc data immediately after loading
        const cbbtcData = JSON.parse(JSON.stringify(yieldData_cbbtc));
        console.log('Loaded cbBTC data:', cbbtcData.metadata.contract, cbbtcData.data.length, 'points');
    </script>
    <script src="../yield_tbtc.js?v=4"></script>
    <script>
        // Store tbtc data immediately after loading
        const tbtcData = JSON.parse(JSON.stringify(yieldData_tbtc));
        console.log('Loaded tBTC data:', tbtcData.metadata.contract, tbtcData.data.length, 'points');
    </script>
    <script src="../yield_syb_wbtc.js?v=4"></script>
    <script>
        // Store syb_wbtc data immediately after loading
        const sybWbtcData = JSON.parse(JSON.stringify(yieldData_syb_wbtc));
        console.log('Loaded syb-WBTC data:', sybWbtcData.metadata.contract, sybWbtcData.data.length, 'points');
    </script>
    <script src="../yield_syb_cbbtc.js?v=4"></script>
    <script>
        // Store syb_cbbtc data immediately after loading
        const sybCbbtcData = JSON.parse(JSON.stringify(yieldData_syb_cbbtc));
        console.log('Loaded syb-cbBTC data:', sybCbbtcData.metadata.contract, sybCbbtcData.data.length, 'points');
    </script>
    <script src="../yield_syb_tbtc.js?v=4"></script>
    <script>
        // Store syb_tbtc data immediately after loading
        const sybTbtcData = JSON.parse(JSON.stringify(yieldData_syb_tbtc));
        console.log('Loaded syb-tBTC data:', sybTbtcData.metadata.contract, sybTbtcData.data.length, 'points');
    </script>

    <script>
        // Market configurations
        const MARKETS = {
            wbtc: {
                name: 'yb-WBTC',
                data: wbtcData,
                contract: '0x6095a220C5567360d459462A25b1AD5aEAD45204'
            },
            cbbtc: {
                name: 'yb-cbBTC',
                data: cbbtcData,
                contract: '0xD6a1147666f6E4d7161caf436d9923D44d901112'
            },
            tbtc: {
                name: 'yb-tBTC',
                data: tbtcData,
                contract: '0x2B513eBe7070Cff91cf699a0BFe5075020C732FF'
            },
            syb_wbtc: {
                name: 'syb-WBTC',
                data: sybWbtcData,
                contract: '0x37f45E64935e7B8383D2f034048B32770B04E8bd'
            },
            syb_cbbtc: {
                name: 'syb-cbBTC',
                data: sybCbbtcData,
                contract: '0x3dAe83d236b4Ec301A8d0553f8c13Cb9b7925B6a'
            },
            syb_tbtc: {
                name: 'syb-tBTC',
                data: sybTbtcData,
                contract: '0x2a4671fd269dF5B3DA03103c74063dA10D03E23C'
            }
        };

        let currentMarket = 'wbtc';
        let currentYieldData = null;
        let originalData = null;
        let charts = {};

        // Load market data
        function loadMarketData(market) {
            const config = MARKETS[market];
            currentYieldData = JSON.parse(JSON.stringify(config.data));
            originalData = JSON.parse(JSON.stringify(config.data));
        }

        // Switch market
        function switchMarket(market) {
            if (market === currentMarket) return;

            console.log('Switching to market:', market);

            // Update active button
            document.querySelectorAll('.market-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-market="${market}"]`).classList.add('active');

            currentMarket = market;

            // Load market data
            loadMarketData(market);
            console.log('Loaded data:', currentYieldData);

            renderContent();
            initializeDateInputs();
            updateMetrics();
            destroyCharts();
            createCharts();
        }

        function showError(message) {
            document.getElementById('content-area').innerHTML = `<div class="error">${message}</div>`;
        }

        function renderContent() {
            document.getElementById('content-area').innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value" id="total-return"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Annualized APR</div>
                        <div class="metric-value" id="apr"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Period</div>
                        <div class="metric-value" id="period"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Data Points</div>
                        <div class="metric-value" id="data-points"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Start PPS</div>
                        <div class="metric-value" id="start-pps"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">End PPS</div>
                        <div class="metric-value" id="end-pps"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">Price Per Share (BTC)</h2>
                    <canvas id="ppsChart"></canvas>
                </div>

                <div class="chart-container" id="gaugeChart" style="display: none;">
                    <h2 class="chart-title">Gauge Token Conversion (syb → yb)</h2>
                    <canvas id="gaugeConversionChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">BTC vs ${MARKETS[currentMarket].name} Price (USD)</h2>
                    <canvas id="priceComparisonChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">Step Returns (%)</h2>
                    <canvas id="returnsChart"></canvas>
                </div>

                <div class="info">
                    <div class="info-title">Contract Information</div>
                    <div class="info-content" id="contract-info"></div>
                </div>
            `;
        }

        function initializeDateInputs() {
            if (!currentYieldData || !currentYieldData.data || currentYieldData.data.length === 0) return;

            const startDate = new Date(currentYieldData.data[0].datetime);
            const endDate = new Date(currentYieldData.data[currentYieldData.data.length - 1].datetime);

            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function applyDateFilter() {
            const startInput = document.getElementById('startDate').value;
            const endInput = document.getElementById('endDate').value;

            if (!startInput || !endInput) {
                alert('Please select both start and end dates');
                return;
            }

            const startTime = new Date(startInput).getTime();
            const endTime = new Date(endInput).getTime();

            const filteredData = originalData.data.filter(d => {
                const timestamp = d.timestamp * 1000;
                return timestamp >= startTime && timestamp <= endTime;
            });

            if (filteredData.length === 0) {
                alert('No data points in selected range');
                return;
            }

            currentYieldData.data = filteredData;
            currentYieldData.metadata.data_points = filteredData.length;
            currentYieldData.metadata.start_date = filteredData[0].datetime;
            currentYieldData.metadata.end_date = filteredData[filteredData.length - 1].datetime;

            const startPps = filteredData[0].pps_btc;
            const endPps = filteredData[filteredData.length - 1].pps_btc;
            const totalReturn = (endPps - startPps) / startPps;
            const days = (filteredData[filteredData.length - 1].timestamp - filteredData[0].timestamp) / 86400;
            const apr = (totalReturn / days) * 365;

            currentYieldData.metrics.start_pps = startPps;
            currentYieldData.metrics.end_pps = endPps;
            currentYieldData.metrics.total_return = totalReturn;
            currentYieldData.metrics.total_return_pct = totalReturn * 100;
            currentYieldData.metrics.apr = apr;
            currentYieldData.metrics.apr_pct = apr * 100;
            currentYieldData.metrics.days = days;

            updateMetrics();
            destroyCharts();
            createCharts();
        }

        function resetDateFilter() {
            currentYieldData.data = JSON.parse(JSON.stringify(originalData.data));
            currentYieldData.metadata = JSON.parse(JSON.stringify(originalData.metadata));
            currentYieldData.metrics = JSON.parse(JSON.stringify(originalData.metrics));

            initializeDateInputs();
            updateMetrics();
            destroyCharts();
            createCharts();
        }

        function destroyCharts() {
            console.log('Destroying charts:', Object.keys(charts));
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        function updateMetrics() {
            document.getElementById('total-return').textContent = currentYieldData.metrics.total_return_pct.toFixed(4) + '%';
            document.getElementById('total-return').className = 'metric-value ' + (currentYieldData.metrics.total_return >= 0 ? 'positive' : 'negative');

            document.getElementById('apr').textContent = currentYieldData.metrics.apr_pct.toFixed(2) + '%';
            document.getElementById('apr').className = 'metric-value ' + (currentYieldData.metrics.apr >= 0 ? 'positive' : 'negative');

            document.getElementById('period').textContent = currentYieldData.metrics.days.toFixed(2) + ' days';
            document.getElementById('data-points').textContent = currentYieldData.metadata.data_points;
            document.getElementById('start-pps').textContent = currentYieldData.metrics.start_pps.toFixed(8) + ' BTC';
            document.getElementById('end-pps').textContent = currentYieldData.metrics.end_pps.toFixed(8) + ' BTC';

            const firstBlock = currentYieldData.data[0].block;
            const lastBlock = currentYieldData.data[currentYieldData.data.length - 1].block;

            document.getElementById('contract-info').innerHTML = `
                Contract: <code>${currentYieldData.metadata.contract}</code><br>
                Period: ${currentYieldData.metadata.start_date} to ${currentYieldData.metadata.end_date}<br>
                Blocks: ${firstBlock} to ${lastBlock}<br>
                Generated: ${new Date().toISOString()}
            `;
        }

        function createCharts() {
            console.log('Creating charts for', currentYieldData.data.length, 'data points');
            const hasBtcPrices = currentYieldData.data.some(d => d.btc_price !== null);

            if (hasBtcPrices) {
                const btcPrices = currentYieldData.data.map(d => d.btc_price);
                const ybPrices = currentYieldData.data.map(d => d.btc_price * d.pps_btc);
                console.log('BTC price range:', Math.min(...btcPrices), '-', Math.max(...btcPrices));

                const btc0 = btcPrices[0];
                const yb0 = ybPrices[0];

                const btcMin = Math.min(...btcPrices);
                const btcMax = Math.max(...btcPrices);
                const ybMin = Math.min(...ybPrices);
                const ybMax = Math.max(...ybPrices);

                const btcRange = btcMax - btcMin;
                const ybRange = ybMax - ybMin;

                const btcInitialPos = btcRange > 0 ? (btc0 - btcMin) / btcRange : 0.5;
                const ybAxisMin = yb0 - btcInitialPos * ybRange;
                const ybAxisMax = ybAxisMin + ybRange;

                const padding = 0.15;
                const btcAxisMin = btcMin - btcRange * padding;
                const btcAxisMax = btcMax + btcRange * padding;
                const ybAxisMinPadded = ybAxisMin - ybRange * padding;
                const ybAxisMaxPadded = ybAxisMax + ybRange * padding;

                const priceCompCtx = document.getElementById('priceComparisonChart').getContext('2d');
                charts.priceComparison = new Chart(priceCompCtx, {
                    type: 'line',
                    data: {
                        labels: currentYieldData.data.map(d => new Date(d.datetime).toLocaleString()),
                        datasets: [
                            {
                                label: 'BTC Price (USD)',
                                data: btcPrices,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y',
                                pointRadius: 0,
                                pointHoverRadius: 4
                            },
                            {
                                label: `${MARKETS[currentMarket].name} Price (USD)`,
                                data: ybPrices,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1',
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#f59e0b',
                                bodyColor: '#e2e8f0',
                                borderColor: '#334155',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '$' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: btcAxisMin,
                                max: btcAxisMax,
                                title: {
                                    display: true,
                                    text: 'BTC Price (USD)',
                                    color: '#3b82f6'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: { color: '#334155' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: ybAxisMinPadded,
                                max: ybAxisMaxPadded,
                                title: {
                                    display: true,
                                    text: `${MARKETS[currentMarket].name} Price (USD)`,
                                    color: '#f59e0b'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
            }

            // PPS Chart
            const ppsCtx = document.getElementById('ppsChart').getContext('2d');
            const ppsValues = currentYieldData.data.map(d => d.pps_btc);
            const ppsMin = Math.min(...ppsValues);
            const ppsMax = Math.max(...ppsValues);
            console.log('PPS range:', ppsMin, '-', ppsMax);
            const ppsRange = ppsMax - ppsMin;
            const ppsPadding = 0.15;
            const ppsAxisMin = ppsMin - ppsRange * ppsPadding;
            const ppsAxisMax = ppsMax + ppsRange * ppsPadding;

            charts.pps = new Chart(ppsCtx, {
                type: 'line',
                data: {
                    labels: currentYieldData.data.map(d => new Date(d.datetime).toLocaleString()),
                    datasets: [{
                        label: 'PPS (BTC)',
                        data: ppsValues,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f59e0b',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(10) + ' BTC';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: ppsAxisMin,
                            max: ppsAxisMax,
                            title: {
                                display: true,
                                text: 'PPS (BTC)',
                                color: '#f59e0b'
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });

            // Gauge Token Conversion Chart (syb → yb)
            const hasGaugeData = currentYieldData.data.some(d => d.pps_yb !== undefined && d.pps_yb !== null);
            const gaugeChartContainer = document.getElementById('gaugeChart');

            if (hasGaugeData) {
                console.log('Creating gauge conversion chart');
                gaugeChartContainer.style.display = 'block';

                const gaugeCtx = document.getElementById('gaugeConversionChart').getContext('2d');
                const gaugeValues = currentYieldData.data.map(d => d.pps_yb);
                const gaugeMin = Math.min(...gaugeValues);
                const gaugeMax = Math.max(...gaugeValues);
                const gaugeRange = gaugeMax - gaugeMin;
                const gaugePadding = 0.15;
                const gaugeAxisMin = gaugeMin - gaugeRange * gaugePadding;
                const gaugeAxisMax = gaugeMax + gaugeRange * gaugePadding;

                charts.gauge = new Chart(gaugeCtx, {
                    type: 'line',
                    data: {
                        labels: currentYieldData.data.map(d => new Date(d.datetime).toLocaleString()),
                        datasets: [{
                            label: 'syb → yb Conversion Rate',
                            data: gaugeValues,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#f59e0b',
                                bodyColor: '#e2e8f0',
                                borderColor: '#334155',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(10) + ' yb';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: gaugeAxisMin,
                                max: gaugeAxisMax,
                                title: {
                                    display: true,
                                    text: 'Conversion Rate (yb per syb)',
                                    color: '#8b5cf6'
                                },
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            x: {
                                ticks: {
                                    color: '#94a3b8',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
            } else {
                console.log('No gauge data, hiding gauge chart');
                gaugeChartContainer.style.display = 'none';
            }

            // Returns Chart
            const returnsCtx = document.getElementById('returnsChart').getContext('2d');
            const returnValues = currentYieldData.data.map(d => d.ret_step_pct);
            const returnMin = Math.min(...returnValues);
            const returnMax = Math.max(...returnValues);
            const returnRange = returnMax - returnMin;
            const returnPadding = 0.15;
            const returnAxisMin = returnMin - returnRange * returnPadding;
            const returnAxisMax = returnMax + returnRange * returnPadding;

            charts.returns = new Chart(returnsCtx, {
                type: 'bar',
                data: {
                    labels: currentYieldData.data.map(d => new Date(d.datetime).toLocaleString()),
                    datasets: [{
                        label: 'Step Return (%)',
                        data: returnValues,
                        backgroundColor: returnValues.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderColor: returnValues.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f59e0b',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            min: returnAxisMin,
                            max: returnAxisMax,
                            title: {
                                display: true,
                                text: 'Return (%)',
                                color: '#f59e0b'
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadMarketData('wbtc');
            renderContent();
            initializeDateInputs();
            updateMetrics();
            createCharts();
        });
    </script>
</body>
</html>
